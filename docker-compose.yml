  version: '2'
    
  services:

    nginx:
      image: nginx:latest
      container_name: production_nginx
      volumes:
        - ./nginx.conf:/etc/nginx/nginx.conf
        - ./nginx/error.log:/etc/nginx/error_log.log
        - ./nginx/cache/:/etc/nginx/cache
        - /etc/letsencrypt/:/etc/letsencrypt/
      ports:
        - 8000:8000
        - 443:443
    db:
      image: postgres
      environment:
        - POSTGRES_DB=postgres
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres

    mopidy:
      build: ./mopidy
      command: mopidy
      ports: 
        - "6680:6680"
        - "6600:6600"
      devices:
        - "/dev/snd:/dev/snd"

    sunrise:
      build: .
      command: uwsgi --show-config
      volumes:
        - .:/sunrise
      expose:
        - "80"
      depends_on:
        - nginx
        - db
        - rabbitmq
        - mopidy
        - celery
        - celery_beat
    celery:
      build: ./celery
      command: celery -A albinso worker -l info
      volumes:
        - .:/sunrise
      depends_on:
        - db
        - rabbitmq
    rabbitmq:
      container_name: rabbitmq
      hostname: rabbitmq
      image: rabbitmq:latest
      ports:
        - "5672:5672"
          #restart: on-failure
    celery_beat:
      build: ./celery
      command: celery -A albinso beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
      volumes:
        - .:/sunrise
      depends_on:
        - db
        - rabbitmq
    kira:
      build: ./kira
      command: /usr/bin/python3 -m http.server 80
      expose:
        - "80"
      depends_on:
        - nginx
